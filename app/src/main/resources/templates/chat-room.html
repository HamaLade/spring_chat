<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${roomDetailInfo.chatRoomName}">채팅방</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .top-bar {
            height: 80px;
            background-color: #757575;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .top-bar a, .top-bar button {
            background-color: #ffffff;
            color: #333333;
            cursor: pointer;
            font-size: 16px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            text-decoration: none;
            margin-left: 10px;
        }

        .content-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .chat-area {
            width: 80%;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #ffffff;
        }

        .chat-input {
            padding: 20px;
            background-color: #f0f0f0;
        }

        .chat-input input {
            width: calc(100% - 100px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .chat-input button {
            width: 80px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .participants-list {
            width: 20%;
            background-color: #ffffff;
            padding: 20px;
            overflow-y: auto;
        }

        .participants-list h3 {
            margin-top: 0;
        }

        .participants-list ul {
            list-style-type: none;
            padding: 0;
        }

        .participants-list li {
            margin-bottom: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #userSearchInput {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
        }

        #userSearchResults {
            list-style-type: none;
            padding: 0;
        }

        #userSearchResults li {
            padding: 10px;
            cursor: pointer;
        }

        #userSearchResults li:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
<div class="top-bar">
    <h2 th:text="${roomDetailInfo.chatRoomName}">채팅방 이름</h2>
    <div>
        <a id="logout" th:if="${#authorization.expression('isAuthenticated()')}" onclick="logout()">로그아웃</a>
        <a id="exit-room" th:if="${#authorization.expression('isAuthenticated()')}" onclick="exitRoom()" style="background-color: #ff0000; color: #ffffff;">나가기</a>
        <a id="invite-user" th:if="${roomDetailInfo.isPrivate}" onclick="openInviteModal()" style="background-color: #4CAF50; color: #ffffff;">유저 초대</a>
    </div>
</div>
<div id="inviteModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeInviteModal()">&times;</span>
        <h2>유저 초대</h2>
        <input type="text" id="userSearchInput" placeholder="유저 검색...">
        <ul id="userSearchResults"></ul>
    </div>
</div>
<div class="content-wrapper">
    <div class="chat-area">
        <div id="chatMessages" class="chat-messages">
            <!-- 채팅 메시지들이 여기에 동적으로 추가됩니다 -->
            <div th:each="recentMessage : ${roomDetailInfo.recentMessages}" class="message">
                <span th:text="${recentMessage.senderNickname} + ': ' + ${recentMessage.message}"></span>
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="메시지를 입력하세요">
            <button onclick="sendMessage()">전송</button>
        </div>
    </div>
    <div class="participants-list">
        <h3>참가자 목록</h3>
        <ul id="participants">
        </ul>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script th:inline="javascript">
    const roomId = [[${roomDetailInfo.chatRoomId}]];
    const memberNickname = [[${roomDetailInfo.memberNickname}]];
    let stompClient = null;
    const participants = new Set();
    /*[# th:each="participant : ${roomDetailInfo.participants}"]*/
    participants.add([[${participant.memberNickname}]]);
    /*[/]*/

    function connect() {
        return new Promise((resolve, reject) => {
            const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
            const host = window.location.hostname;

            const wsUrl = `${protocol}//${host}/chat`;

            let socket = new SockJS(wsUrl, null, {
                transports: ["websocket", "xhr-streaming", "xhr-polling"],
                withCredentials: true
            });
            let connectionTimeout = setTimeout(() => {
                alert('서버와 연결할 수 없습니다. 다시 시도해주세요.');
                socket.close();
                reject('Connection timeout');
            }, 2000);
            stompClient = Stomp.over(socket);
            stompClient.connect({
                Authorization: [[${roomDetailInfo.authCode}]]
            }, function (frame) {
                stompClient.subscribe('/subscribe/chat/room/' + roomId, function (message) {
                    showMessage(JSON.parse(message.body));
                });
                stompClient.subscribe('/subscribe/chat/join/room/' + roomId, function (message) {
                    showParticipants(JSON.parse(message.body));
                });
                // 에러 메시지 구독 추가
                stompClient.subscribe('/queue/errors/' + memberNickname, function (message) {
                    alert('에러: ' + message.body)
                });
                clearTimeout(connectionTimeout);
                resolve(stompClient);
            }, error => {
                console.error('STOMP error', error);
                reject(error);
            });
        });
    }

    function exitRoom() {
        fetch('/chat/rooms/exit/' + roomId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(function (response) {
            console.log(response);
            if (response.ok) {
                location.href = '/chat/rooms';
            }
        }).catch(function (error) {
            console.log('Exit room failed', error);
        });
    }


    async function setUpChatRoom() {
        try {
            await connect();
            let join = {
                memberNickname: memberNickname
            };
            stompClient.send("/publish/chat/join/" + roomId, {}, JSON.stringify(join));
            showParticipants(null);
        } catch (error) {
            console.error('Failed to set up chat room', error);
            window.location.href = '/';
        }
    }

    function showParticipants(message) {
        if (message) {
            participants.add(message.memberNickname);
        }
        let participantsList = document.getElementById('participants');
        participantsList.innerHTML = '';
        Array.from(participants).sort().forEach(participant => {
            let li = document.createElement('li');
            li.textContent = participant;
            participantsList.appendChild(li);
        });
    }

    document.getElementById('messageInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function sendMessage() {
        let messageContent = document.getElementById('messageInput').value;
        if (messageContent && stompClient) {
            let chatMessage = {
                roomId: roomId,
                chatType: 'REGULAR',
                message: messageContent,
                senderNickname: memberNickname,
                hasFile: false
            };
            stompClient.send("/publish/chat/message/" + roomId, {}, JSON.stringify(chatMessage));
            document.getElementById('messageInput').value = '';
        }
    }

    function showMessage(message) {
        let messageElement = document.createElement('div');
        messageElement.textContent = message.memberNickname + ": " + message.textContent;
        document.getElementById('chatMessages').appendChild(messageElement);
    }

    document.addEventListener('DOMContentLoaded', function () {
        setUpChatRoom();
    });

    function logout() {
        fetch('/members/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(function (response) {
            console.log(response);
            if (response.ok) {
                location.href = '/';
            }
        }).catch(function (error) {
            console.log('Logout failed', error);
        });
    }

    let selectedUser = null;

    function openInviteModal() {
        document.getElementById('inviteModal').style.display = 'block';
    }

    function closeInviteModal() {
        document.getElementById('inviteModal').style.display = 'none';
        document.getElementById('userSearchInput').value = '';
        document.getElementById('userSearchResults').innerHTML = '';
        selectedUser = null;
    }

    function searchUser() {
        const searchInput = document.getElementById('userSearchInput').value;
        // 여기에 사용자 검색 API 호출 로직 추가
        // 예시:
        fetch('/members/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ memberNickname: searchInput })
        })
            .then(response => response.json())
            .then(json => {
                const resultsList = document.getElementById('userSearchResults');
                resultsList.innerHTML = '';
                json.data.forEach(user => {
                    const li = document.createElement('li');
                    li.textContent = user;
                    li.onclick = () => confirm('초대하시겠습니까?') && inviteUser(user);
                    resultsList.appendChild(li);
                });
            });
    }

    function inviteUser(inviteMemberNickname) {

        fetch(`/chat/rooms/invite/${roomId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ memberNickname: inviteMemberNickname })
        })
            .then(response => {
                if (response.ok) {
                    alert('초대가 성공적으로 전송되었습니다.');
                    showParticipants({ memberNickname: inviteMemberNickname })
                    closeInviteModal();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || '초대 중 오류가 발생했습니다.');
                    });
                }
            })
            .catch(error => {
                alert(error.message);
            });
    }

    document.getElementById('userSearchInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            searchUser();
        }
    });
</script>
</body>
</html>